# Chatbot

<img width="1918" height="917" alt="ss" src="https://github.com/user-attachments/assets/1efce700-8e3b-4320-92f3-d4c716aac420" />

## 概要
Gemini向けのチャットボットフロントエンドです。自分が欲しい機能を求めて作成しました。完全にデスクトップ環境向けの設計となっています。
* 十分なテストを実施できていません。バグの可能性は大いにあり得ますので、ご注意ください。問題が確認された場合は、フィードバックをいただければ幸いです。また、履歴が肥大化した際等のパフォーマンスについても未検証です。
* テキスト及び画像生成（nano banana）に対応しています。その他モデルもデフォルトではモデル一覧に表示されるようになっていますが、実際には利用不可能です。
* function callingを除けば、概ねGoogle AI Studioと同等の操作が可能になっていると思われます。その他、レスポンスの置換機能、自動parts挿入機能（Auto Inserted Messages）といったものも実装しています。
> 自動parts挿入機能は、Gemini PWAにおけるDummy prompt機能と同様のものです。入力プロンプトに対して、Userロール及びModelロールのpartsを追加してリクエストを行います。ファイル添付にも対応しているため、描写統制用の資料を直近の指示に追従させるといった使い方も可能です。

## 環境
- Node.js
- npm

## セットアップ手順
1. Releaseにある最新のzipファイル（`chatbot_v*.zip`）を解凍し、展開されたディレクトリに移動します。
2. Node.js を含む環境変数が適切に設定されていることを確認します。
3. バックエンドで管理する設定ファイルは次の通りです。
   - `.env`現状ではモデル一覧の挙動を指定するものです。
   - `key`GeminiのAPIキーを記述するためのファイルです。
   - `system_instruction.txt`デフォルトのシステムプロンプトを記述します。この内容はフロントエンドでシステムプロンプトが指定されていない場合にのみ有効となります。

## 起動方法

### 簡単な起動（推奨）
**Windows:**
`launch.bat` をダブルクリックします。依存関係の自動インストール、サーバー起動、ブラウザの自動起動が行われます。

**Mac/Linux:**
ターミナルで以下を実行します：
```bash
./launch.sh
```

### 手動起動
1. 依存パッケージをインストールします（初回のみ）。
   ```bash
   npm i
   ```
2. 展開されたディレクトリ内でサーバーを起動します。
   ```bash
   node server.js
   ```
3. ブラウザで `http://localhost:3001/chatbot` にアクセスするとアプリケーションを利用できます。

## データ管理に関する注意
アプリケーションはブラウザの IndexedDB を利用してデータを保存します。ブラウザの設定やストレージのクリーンアップ操作によってデータが削除される可能性がある点に注意してください。

## 挙動について
* システムプロンプトは、フロントエンドのモデル設定で保存されたものが、新規チャット作成時にチャット固有の設定として反映されます。チャット内では常にチャット固有のシステムプロンプトが使用されます。
* チャット固有のシステムプロンプトが設定されていない（空白）の場合、バックエンド側のシステムプロンプトが使用されます。
* ファイル添付は、10MBを境にinlineDataとFileAPIに分岐します。
* 文字列置換はレスポンスの受け取りが完了した時点で実行されます。この際、書式が不正な場合その処理はスキップされます。
* **keyファイルについて**:
  - 初期状態では空の`key`ファイルが配布されます。
  - APIキーを設定して初回起動すると、セキュリティのため自動的に`key_valid`にリネームされます。

